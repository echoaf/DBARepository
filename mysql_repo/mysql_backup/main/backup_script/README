================= MySQL 相关脚本 #####################

################# mysql_backup_build.py
mysql_backup_build.py:MySQL备库一键搭建
一、逻辑
先找是否存在已经有效的并且一周之内的备份集,如果存在从已有备份集恢复
如果不存在先做好备份集,然后从做好的备份集恢复


二、参数说明:
source:备份数据源(IP:PORT)
如果backup_mode是mydumper,当source为最上游主库,master为source,当source是从库,master为source的master
如果backup_mode是xtrbackup,master即是source,后期可能还需要切换master

dest:还原地址(IP:PORT)
如果backup_mode是mydumper,dest必须是一个启动的空的实例(不包括系统库外其他数据库)
如果backup_mode是xtrbackup,dest必须是一个启动的空的实例(不包括系统库外其他数据库),会被物理备份替换

backup_mode:备份方式('mydumper|xtrabackup')

logic_threads='':mydumper线程数,默认为4
这里指dump线程数,load线程数为dump线程数的2倍,比如logic_threads=4,则dump为4,load为8

backup_path:备份地址,不能已经存在数据

force_backup:是否强制备份(Y|N),默认为N
Y:不检查是否存在有效备份集
N:检测是否存在有效备份集


三、Tips:
1、mydumper和myloader时候需要判断磁盘可利用空间:当前机器是否有空间,slave是否有空间
2、myloader恢复时候不会写binlog,并且关闭慢日志,恢复完成后打开慢日志
3、myloader恢复之后会自动打开slave
4、恢复完成后录入到MySQL信息表
5、xtrabackup备份方式需要先把密钥做好,否则会退出包括备份机器和master的免密钥，备份机器和slave的免密钥
6、恢复完成后需要flush privileges
7、backupXtrabackup目录是xtrbackup备份的文件
8、mydumper metadata可能的一个内容
Started dump at: 2018-10-17 14:52:35
SHOW MASTER STATUS:
    Log: binlog.000007
    Pos: 865474526
    GTID:3c06e18e-c154-11e8-9c9a-000c296fab33:1-3290904,
3e5cda33-c154-11e8-9e09-000c296fab33:1-7483

SHOW SLAVE STATUS:
    Host: 172.16.112.10
    Log: binlog.000008
    Pos: 48477261
    GTID:3c06e18e-c154-11e8-9c9a-000c296fab33:1-3290904,
3e5cda33-c154-11e8-9e09-000c296fab33:1-7483

Finished dump at: 2018-10-17 14:52:38

四、bug:
1、备份和恢复时间可能会比较久,需要注意主库binlog是否已被删除

无、测试

172.16.112.10:10000 master
172.16.112.10:11000 masterbackup

python mysql_backup_build.py --source="172.16.112.10:10000" --dest="172.16.112.10:40000" --backup_path="/data/tmpdir/40000" --backup_mode="xtrabackup" --innodb_buff=512M
python mysql_backup_build.py --source="172.16.112.10:11000" --dest="172.16.112.10:40001" --backup_path="/data/tmpdir/40001/" --backup_mode="xtrabackup" --innodb_buff=512M
11000 stop slave
python mysql_backup_build.py --source="172.16.112.10:11000" --dest="172.16.112.10:40002" --backup_path="/data/tmpdir/40002/" --backup_mode="xtrabackup" --innodb_buff=512M

python mysql_backup_build.py --backup_mode="mydumper" --source="172.16.112.10:10000" --dest="172.16.112.10:40001" --backup_path="/data/tmpdir/40001" --logic_threads=4 
python mysql_backup_build.py --backup_mode="mydumper" --source="172.16.112.10:11000" --dest="172.16.112.10:40001" --backup_path="/data/tmpdir/40001" --logic_threads=4 
11000 stop slave
python mysql_backup_build.py --backup_mode="mydumper" --source="172.16.112.10:11000" --dest="172.16.112.10:40001" --backup_path="/data/tmpdir/40001" --logic_threads=4 
